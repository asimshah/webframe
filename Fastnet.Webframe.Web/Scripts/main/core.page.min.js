var t$m=null;(function(n){var t,i,r=function(){function t(){function t(t){n.push(t)}var n=[];return{masterId:null,addMenu:t,loaded:!1,data:null,menuList:n}}function i(){return n||(n=new t),n}var n=null;return{get:i}};n.core$page={toolbar:null,pageEditor:null,isEditing:!1,options:null,panelData:{Access:null,EditablePanels:[{pageId:null,selector:".CentrePanel",masterMenus:[],menuList:[],menuIdList:null,menuData:[]},{pageId:null,selector:".BannerPanel",masterMenus:[],menuList:[],menuIdList:null,menuData:[]},{pageId:null,selector:".LeftPanel",masterMenus:[],menuList:[],menuIdList:null,menuData:[]},{pageId:null,selector:".RightPanel",masterMenus:[],menuList:[],menuIdList:null,menuData:[]}],MenuPanel:{masterMenus:[],menuList:[],menuData:[]}},Init:function(){function r(){t.ParkAllMenus();t.pageEditor.LoadEditors()}function u(){var n=t.pageEditor.UnloadEditors();n&&t.RestoreAllMenus()}t=this;i=n.fastnet$utilities;t.toolbar=PageToolbar.get();t.toolbar.addHandler("toolbar-opened",r);t.toolbar.addHandler("exit-edit-mode",u);t.pageEditor=PageEditor.get();t.pageEditor.SetChangePageHandler(function(n){i.Debug("Editor asked for new page {0}",n.url);t.GotoInternalLink(n.url)});n(window).bind("popstate",function(){navigator.appVersion.toLowerCase().indexOf("safari")===-1&&(location.href=location.href)})},FindEditablePanel:function(i){var r=null;return n.each(t.panelData.EditablePanels,function(n,t){if(t.selector===i)return r=t,!1}),r},RestoreAllMenus:function(){function r(t,r){n(t).find(".menu-location").empty();n.each(r,function(r,u){n.each(u.menuList,function(n,r){i.Debug("Should restore: {0}, master {1} menu {2}",t,u.masterId,r.getId());r.restore()})})}n.each(t.panelData.EditablePanels,function(n,t){r(t.selector,t.masterMenus)})},ParkAllMenus:function(){function i(t,i){n.each(i,function(t,i){n.each(i.menuList,function(n,t){t.park()})})}n.each(t.panelData.EditablePanels,function(n,t){i(t.selector,t.masterMenus)})},CreateMenus2:function(r,u){function c(t){var i=null;return n.each(e,function(n,r){if(r.masterId===t)return i=r,!1}),i}function f(r,u,f){var e=i.Format("pageapi/menu/{0}",u.Id);n.when(i.AjaxGet({url:e})).then(function(i){var o=c(u.Id),e,s,h;o.loaded=!0;i.length>0&&(e=Menu.get(),t$m=e,s=n.extend({menuClasses:[u.Name,u.ClassName]},f),h=e.create(r,i,s),o.addMenu(e),o.data=i,n(t.panelData).trigger("menucreated",{selector:r,menuId:e.getId()}))})}var e=u.masterMenus,o=[],s,h;n.each(e,function(n,t){o.push(t.masterId)});s="pageapi/menu/master";h={option:null,idList:o};n.when(i.AjaxPost({url:s,data:h})).then(function(t){n.each(t,function(n,t){switch(t.Panel){case"menupanel":f(".MenuPanel",t);break;case"bannerpanel":f(".BannerPanel",t);break;case"leftpanel":f(".LeftPanel",t,{direction:"vertical"});break;case"rightpanel":f(".RightPanel",t,{direction:"vertical"})}})})},GotoInternalLink:function(i){switch(i){case"/home":case"login":t.ShowDialog("login");break;case"/register":case"/recoverpassword":case"/studio":case"/membership":n.fastnet$account.AccountOperation(i);break;case"/userprofile":t.ShowDialog("userprofile");break;default:i.startsWith("page/")&&(t.SetPage(i.substring(5)),window.history.pushState({href:i},null,i))}},IsLinkInternal:function(i){function e(t){var i=!1;return n.each(u,function(n,r){return i=t===r,i?!1:void 0}),i}var r=!1,u,f;return i=t.StandardiseUrl(i),u=["login","logon","login","logoff","register","recoverpassword"],f=!(i.startsWith("http")||i.startsWith("file")||i.startsWith("mailto")),f&&(r=e(i)?!0:i.startsWith("page/")||i.startsWith("document/")||i.startsWith("video/")),r},ShowDialog:function(t){var r=i.Format("model/{0}",t);n.when(i.AjaxGet({url:r})).then(function(t){n.fastnet$account.Start(t,function(){})})},StandardiseUrl:function(t){var i=n("head base").attr("href");return t=t.toLowerCase(),t.startsWith(i)&&(t=t.substring(i.length,t.length-i.length)),t.startsWith("http")||t.startsWith("file")||t.startsWith("mailto")||t.startsWith("/")&&(t=t.substring(1)),t},LoadStartPage:function(u){t.SetReponsiveFeatures();var f=u;t.panelData.MenuPanel.masterMenus=[];n.when(i.AjaxGet({url:"pageapi/menupanel/get/menumasters"},!0)).then(function(i){n.each(i,function(n,i){var u=(new r).get();u.masterId=i;t.panelData.MenuPanel.masterMenus.push(u)});t.CreateMenus2(".MenuPanel",t.panelData.MenuPanel);t.SetPage(f);t.QueryAuthentication()})},ParallelCalls:function(){n.when(i.AjaxGet({url:"main/special/echo/2"}),i.AjaxGet({url:"main/special/echo/5"})).then(function(){alert("both done");i.MessageBox("#exampleModal")})},QueryAuthentication:function(){n.when(i.AjaxGet({url:"account/currentuser"},!0)).then(function(t){if(t.Authenticated){var r=t.EmailAddress,i=t.Name;n(".login-name").html(i).removeClass("hide")}else n(".login-name").addClass("hide").html("")})},SetPage:function(r){n.when(i.AjaxGet({url:"pageapi/sidepages/"+r}),i.AjaxGet({url:"pageapi/page/access/"+r})).then(function(i,u){var f=i[0],e=r,o=u[0].Access;t.UpdatePanel(t.FindEditablePanel(".BannerPanel"),f.Banner);t.UpdatePanel(t.FindEditablePanel(".LeftPanel"),f.Left);t.UpdatePanel(t.FindEditablePanel(".RightPanel"),f.Right);t.UpdatePanel(t.FindEditablePanel(".CentrePanel"),{Id:e,Menu:null});n(".SitePanel .login-status").off();n(".SitePanel .login-status").on("click",function(){t.GotoInternalLink("/userprofile")});t.panelData.Access=o;t.panelData.Access=="editallowed"?t.toolbar.show():t.toolbar.hide()})},Start:function(r){if(i.Debug("pathname = {0}, {1}",location.pathname,location.href),t.options=r,t.options.ClientSideLog&&n.fastnet$utilities.EnableClientSideLog(),t.LoadStartPage(r.StartPage),r.HasAction&&r.ShowDialog){var u=location.href,f=i.Format("{0}//{1}",location.protocol,location.host);window.history.pushState({href:u},null,f);n.fastnet$account.Start(r,function(){t.QueryAuthentication()})}},ClearContent:function(t){var r=t.selector.substr(1).toLowerCase(),u=i.Format("{0}-style",r);n("head").find("#"+u).remove();n(t).empty();t.pageId==null;t.Menu=null},UpdatePanel:function(u,f){u.pageId!==f.Id&&(f.Id!=null?(u.masterMenus=[],u.pageId=f.Id,u.menuIdList=f.MenuList,f.MenuList!=null&&n.each(f.MenuList,function(n,t){var i=(new r).get();i.masterId=t;u.masterMenus.push(i)}),n.when(i.AjaxGet({url:"pageapi/page/"+u.pageId})).then(function(n){t.SetContent(u,{access:n.Access,styleList:n.HtmlStyles,html:n.HtmlText,pageId:n.PageId,location:n.Location})})):t.ClearContent(u))},SetContent:function(r,u){var s=u.styleList,c=u.html,o,e;if(typeof s!="string"){var e=r.selector.substr(1).toLowerCase(),h=i.Format("{0}-style",e),f=i.Format("<style id='{0}'>",h);n.each(s,function(t,u){f+=i.Format("{0} {1}",r.selector,u.Selector);f+=" {";n.each(u.Rules,function(n,t){f+=t+"; "});f+="} "});f+="<\/style>";n("head").find("#"+h).remove();n("head").append(n(f))}n(r.selector).off();o=n(c);o.find("a").on("click",function(i){var r=n(this).attr("href");t.IsLinkInternal(r)&&(i.preventDefault(),r=t.StandardiseUrl(r),t.GotoInternalLink(r))});e=r.selector.substr(1).toLowerCase();n(r.selector).empty().append(o);n(r.selector).attr("data-page-id",u.pageId);n(r.selector).attr("data-panel",e);n(r.selector).attr("data-location",u.location);n(r.selector).find(".menu-location").empty();t.CreateMenus2(r.selector,r)},OnBarCommand:function(n){var r=null,u;switch(n){case"show-main-menu":r=t.panelData.MenuPanel.masterMenus;break;case"show-left-menu":u=t.FindEditablePanel(".LeftPanel");r=u.masterMenus;break;case"show-right-menu":u=t.FindEditablePanel(".RightPanel");r=u.masterMenus;break;default:i.Debug("bars: {0}",n)}t.ShowBarMenu(n,r)},ShowBarMenu:function(t,r){function f(){function t(r,u,f){var o,s;if(u.Submenus.length>0){var h=i.Format("<li class='has-children is-closed'><a><span>{0}<\/span> <span class='fa fa-arrow-circle-down'><\/span><\/a><ul data-level='{1}'><\/ul><\/li>",u.Text,f),e=n(h),c=n(e).find("ul");r.append(e);n.each(u.Submenus,function(n,i){t(c,i,f+1)})}else o="<li><a href='{0}'><span>{1}<\/span><\/a><\/li>",s=i.Format(o,u.Url,u.Text),r.append(n(s))}n(".bar-menu").empty();n.each(r,function(i,r){if(r.data!==null){var u=n("<ul data-level='0'><\/ul>").appendTo(n(".bar-menu"));n.each(r.data,function(n,i){t(u,i,1)})}})}var e=n(".bar-menu").attr("data-current"),u;if(n(".bar-menu").slideUp(),e!==t){f();u=n(".menu-bars-container").outerHeight();n("ul[data-level='1'], ul[data-level='2']").slideUp();n(".bar-menu").css({top:u}).slideDown();n(".bar-menu").attr("data-current",t);n(".bar-menu a").on("click",function(t){var i=n(this).closest("li"),u=n(i).siblings(),r;u.each(function(t,i){n(i).hasClass("is-open")&&(n(i).find("li.is-open").removeClass("is-open").addClass("is-closed"),n(i).find("ul").slideUp(),n(i).removeClass("is-open").addClass("is-closed"))});n(i).hasClass("has-children")?(t.stopPropagation(),r=parseInt(n(i).closest("ul").attr("data-level")),r++,n(i).hasClass("is-closed")?(n(i).find("ul[data-level='"+r+"']").slideDown(),n(i).removeClass("is-closed").addClass("is-open"),n(i).find("> a span.fa").removeClass("fa-arrow-circle-down").addClass("fa-arrow-circle-up")):(n(i).find("ul[data-level='"+r+"']").slideUp(),n(i).addClass("is-closed").removeClass("is-open"),n(i).find("> a span.fa").removeClass("fa-arrow-circle-up").addClass("fa-arrow-circle-down"))):(n(".bar-menu").removeAttr("data-current"),n(".bar-menu").slideUp())})}else n(".bar-menu").removeAttr("data-current")},LoadEditor:function(i){if(!n.core$editor){var r=[];n.each(["scripts/jquery-ui-1.11.4.min.js","scripts/datatables/jquery.datatables.js","scripts/tinymce/tinymce.js","scripts/dropzone/dropzone.js","scripts/fastnet/fastnet.contextmenu.js","scripts/fastnet/fastnet.treeview.js","scripts/main/core.editor.js"],function(n,i){r.push(t.AjaxGetScript({url:i}))});n.when.apply(n,r).then(function(){i()})}},AjaxGetScript:function(t){return n(".ajax-error-message").empty(),n.ajax({url:"/"+t.url,dataType:"script",type:"GET",cache:!0,crossDomain:!0})},SetReponsiveFeatures:function(){n(".main-bars").hide();n(".left-bars").hide();n(".right-bars").hide();n(t.panelData).on("menucreated",function(t,i){switch(i.selector){case".MenuPanel":n(".main-bars").show();break;case".LeftPanel":n(".left-bars").show();break;case".RightPanel":n(".right-bars").show()}});n(".SitePanel .bars").on("click",function(i){i.stopPropagation();var r=n(this).attr("data-cmd");t.OnBarCommand(r)})}};n(function(){n.core$page.Init()})})(jQuery);
//# sourceMappingURL=core.page.min.js.map
